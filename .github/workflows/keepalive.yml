name: Keepalive Workflow

on:
  schedule:
    - cron: "0 10 1 * *" # æ¯æœˆ1å· 10:00 UTC 

  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
    inputs:
      tags:
        description: 'Just for a test!'
        required: true
        default: 'test'
        type: string

jobs:
  keepalive:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å…è®¸push
    outputs:
      output1: ${{ steps.step2.outputs.SHA_1 }} #ä¼ é€’åˆå§‹çš„SHA
    steps:
      - name: Checkout repository
        id: step1
        uses: actions/checkout@v4
      - name: Update keepalive timestamp
        id: step2
        run: | #å°†æ–‡ä»¶ .keepalive ä¿®æ”¹ä¸ºç°åœ¨æ—¶é—´pushä¸Šå»
          SHA_1=$(git log -1 --format="%H")
          echo "SHA_1=$SHA_1" >> $GITHUB_OUTPUT
          date > .keepalive   
          git config user.name "keepalive[bot]"
          git config user.email "keepalive@keepalive.bot.com"
          git add .keepalive
          git commit -m "chore: keepalive commit" -m "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" || echo "No changes to commit"
          git push
              
  check_push:
    runs-on: ubuntu-latest
    needs: keepalive
    outputs:
      output1: ${{ steps.step2.outputs.VERIFY_SUCCESS }} 
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4 #é»˜è®¤ä¼šæ£€å‡ºè§¦å‘ workflow çš„é‚£ä¸ª commit è€Œä¸æ˜¯ keepalive pushçš„ä»“åº“
        with:
          ref: refs/heads/${{ github.ref_name }}   # å¼ºåˆ¶æ‹‰å–åˆ†æ”¯æœ€æ–°çŠ¶æ€ å³keepalive ä¸­çš„æäº¤
      - name: check_push
        id: step2
        env:
          SHA_1: ${{ needs.keepalive.outputs.output1}}
        run: |

          SHA_2=$(git log -1 --format="%H")
          
          echo "SHA_1=$SHA_1"   
          echo "SHA_2=$SHA_2"             
      
          if [ "$SHA_1" != "$SHA_2" ]; then  # åˆ¤æ–­keepaliveå‰åä»“åº“æ˜¯å¦ä¸€è‡´æ¥åˆ¤æ–­ push æ˜¯å¦æˆåŠŸ
              echo "VERIFY_SUCCESS=YES" >> $GITHUB_OUTPUT
              echo "keepalive success!"
          else
              echo "VERIFY_SUCCESS=NO" >> $GITHUB_OUTPUT
              echo "keepalive fail!"
          fi
          
  telegram_alert:
    runs-on: ubuntu-latest
    needs: check_push
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4 #é»˜è®¤ä¼šæ£€å‡ºè§¦å‘ workflow çš„é‚£ä¸ª commit è€Œä¸æ˜¯ keepalive pushçš„ä»“åº“
        with:
          ref: refs/heads/${{ github.ref_name }}
      - name: collect infomation 
        run: |
          LAST_COMMITTER=$(git log -1 --format="%cn")
          echo "LAST_COMMITTER=$LAST_COMMITTER" >> $GITHUB_ENV
          RECENT_TIME=$(git log -1 --format=%cr)
          echo "RECENT_TIME=$RECENT_TIME" >> $GITHUB_ENV
          LATEST_TIME=$(git log -1 --format=%cI)
          echo "LATEST_TIME=$LATEST_TIME" >> $GITHUB_ENV
          LAST_MESSAGE=$(git log -1 --format="%s")
          echo "LAST_MESSAGE=$LAST_MESSAGE" >> $GITHUB_ENV

      - name: send2telegram
        uses: metalpoch/telegram-alerts-action@v1
        env:
          VERIFY_SUCCESS: ${{ needs.check_push.outputs.output1}}
        with:
          bot-token-id: ${{ secrets.TG_BOT_TOKEN }}
          chat-id: ${{ secrets.TG_USER_ID }}
          text: |
            ğŸ‰æ˜¯å¦æˆåŠŸæäº¤ï¼š${{ VERIFY_SUCCESS }}
            ğŸ‘¤ä½œè€…ï¼š${{ env.LAST_COMMITTER }}
            ğŸ“…æäº¤æ—¶é—´ï¼š${{ env.RECENT_TIME }}
                      ${{ env.LATEST_TIME }} 
            âœ‰ï¸æäº¤ä¿¡æ¯ï¼š${{ env.LAST_MESSAGE }}
            ğŸ”—æŸ¥çœ‹æäº¤ï¼šhttps://github.com/${{ github.repository }}/commit/${{ env.SHA_2 }}
            
          parse-mode: HTML
          disable-notification: true
          disable-web-page-preview: true
          

