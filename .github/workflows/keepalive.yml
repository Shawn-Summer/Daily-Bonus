name: Keepalive Workflow

on:
  schedule:
    - cron: "0 10 1 * *" # 每月1号 10:00 UTC 

  workflow_dispatch: # 手动触发
    inputs:
      tags:
        description: 'Just for a test!'
        required: true
        default: 'test'
        type: string

jobs:
  keepalive:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 允许push
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
          
      - name: Update keepalive timestamp
        run: | #将文件 .keepalive 修改为现在时间push上去
          SHA_1=$(git log -1 --format="%H")
          echo "SHA_1=$SHA_1" >> $GITHUB_ENV
          date > .keepalive   
          git config user.name "keepalive[bot]"
          git config user.email "keepalive@keepalive.bot.com"
          git add .keepalive
          git commit -m "chore: keepalive commit \n $(date -u +"%Y-%m-%dT%H:%M:%SZ")" || echo "No changes to commit"
          git push
          
  verify:
    runs-on: ubuntu-latest
    needs: keepalive
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4 #默认会检出触发 workflow 的那个 commit 而不是 keepalive push的仓库
        with:
          ref: refs/heads/${{ github.ref_name }}   # 强制拉取分支最新状态 即keepalive 中的提交
      - name: verify
        run: |

          LAST_COMMITTER=$(git log -1 --format="%cn")
          echo "LAST_COMMITTER=$LAST_COMMITTER" >> $GITHUB_ENV

          RECENT_TIME=$(git log -1 --format=%cr)
          echo "RECENT_TIME=$RECENT_TIME" >> $GITHUB_ENV
          
          LATEST_TIME=$(git log -1 --format=%cI)
          echo "LATEST_TIME=$LATEST_TIME" >> $GITHUB_ENV
          
          LAST_MESSAGE=$(git log -1 --format="%s")
          echo "LAST_MESSAGE=$LAST_MESSAGE" >> $GITHUB_ENV

          SHA_1=${{ env.SHA_1 }}
          SHA_2=$(git log -1 --format="%H")
          
          echo "SHA_1=$SHA_1"   
          echo "SHA_2=$SHA_2"             
      
          if [ "$SHA_1" != "$SHA_2" ]; then  # 判断keepalive前后仓库是否一致
              echo "VERIFY_SUCCESS=YES" >> $GITHUB_ENV
              echo "keepalive success!"
          else
              echo "VERIFY_SUCCESS=NO" >> $GITHUB_ENV
              echo "keepalive fail!"
          fi
          
          

      - name: send2telegram
        uses: metalpoch/telegram-alerts-action@v1
        with:
          bot-token-id: ${{ secrets.TG_BOT_TOKEN }}
          chat-id: ${{ secrets.TG_USER_ID }}
          text: |
            🎉是否成功提交：${{ env.VERIFY_SUCCESS }}
            👤作者：${{ env.LAST_COMMITTER }}
            📅提交时间：${{ env.RECENT_TIME }}
                      ${{ env.LATEST_TIME }} 
            ✉️提交信息：${{ env.LAST_MESSAGE }}
            🔗查看提交：https://github.com/${{ github.repository }}/commit/${{ env.SHA_2 }}
            
          parse-mode: HTML
          disable-notification: true
          disable-web-page-preview: true
          
# token: ${{ secrets.TG_BOT_TOKEN }}
# chatid: ${{ secrets.TG_USER_ID }}
